<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Noyer â€” Ã‰tape 2</title>
  <link rel="stylesheet" href="styles.css" />
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600&display=swap" rel="stylesheet">
</head>
<body>
  <header class="top-bar">
    <span class="logo-text">Noyer</span>
  </header>

  <main class="container">
    <section class="hero">
      <h1>Informations supplÃ©mentaires</h1>
      <p class="subtitle">
        Votre site est compatible âœ…<br>
        ComplÃ©tez les informations suivantes pour finaliser la configuration.
      </p>
    </section>

    <section class="card">
      <form id="extra-form" class="form-grid">
        <div class="field-group full-width">
          <label>ğŸ¢ Nom de votre agence</label>
          <input id="nom_agence" name="nom_agence" type="text" placeholder="Ex : Agence Grandjean Immobilier" required />
        </div>

        <div class="field-group">
          <label>ğŸŒ URL de la page des biens</label>
          <input id="page_url" name="page_url" type="url" placeholder="https://www.votre-agence.fr/biens" required />
        </div>

        <div class="field-group">
          <label>ğŸ  URL dâ€™un bien</label>
          <input id="example_url" name="example_url" type="url" placeholder="https://www.votre-agence.fr/biens/maison-123" required />
        </div>

        <div class="field-group">
          <label>ğŸ  URL dâ€™un autre bien</label>
          <input id="extra_bien" name="extra_bien" type="url" placeholder="https://www.votre-agence.fr/biens/maison-456" required />
        </div>

        <div class="field-group">
          <label>ğŸ·ï¸ URL du logo</label>
          <input id="logo" name="logo" type="url" placeholder="https://www.votre-agence.fr/logo.png" required />
        </div>

        <div class="field-group photo-group">
          <label>ğŸ–¼ï¸ URL dâ€™une photo de bien 1</label>
          <input id="photo1" name="photo1" type="url" placeholder="https://www.votre-agence.fr/images/photo1.jpg" required />
        </div>

        <div class="field-group photo-group">
          <label>ğŸ–¼ï¸ URL dâ€™une photo de bien 2</label>
          <input id="photo2" name="photo2" type="url" placeholder="https://www.votre-agence.fr/images/photo2.jpg" required />
        </div>
      </form>

      <p class="info-note">
        ğŸ’¡ Pour trouver les URL de photos, ouvrez une page de bien sur votre site, 
        faites un clic droit sur deux photos diffÃ©rentes, puis choisissez 
        â€œCopier lâ€™adresse de lâ€™imageâ€.
      </p>

      <button id="sendBtn" type="submit" form="extra-form" class="btn-primary">
        ğŸš€ Sâ€™abonner Ã  Noyer
      </button>

      <p id="status" class="status"></p>
    </section>

    <footer class="foot">
      <small>Â© 2025 Noyer. Tous droits rÃ©servÃ©s.</small>
    </footer>
  </main>

  <script src="https://js.stripe.com/v3/"></script>
  <script>
    // RÃ©cupÃ©ration automatique des paramÃ¨tres URL (depuis page 1)
    const params = new URLSearchParams(window.location.search);
    const nomAgence = params.get("agency_name");
    const pageUrl = params.get("page_url");
    const exampleUrl = params.get("example_url");

    if (nomAgence) document.getElementById("nom_agence").value = decodeURIComponent(nomAgence);
    if (pageUrl) document.getElementById("page_url").value = decodeURIComponent(pageUrl);
    if (exampleUrl) document.getElementById("example_url").value = decodeURIComponent(exampleUrl);

    const stripe = Stripe("pk_test_51SQ7b0KtSUAGLnZOQ518zmedFbxdcflIBXz0DQ9Ve7XumgSGSOcbM5GDcxe4Ct5Rh8QxcNlqXnsCJfiwFuB0KMvt00kO1VJv91");

    document.getElementById("sendBtn").addEventListener("click", async (e) => {
      e.preventDefault();

      const nom_agence = document.getElementById("nom_agence").value.trim();
      const page_url = document.getElementById("page_url").value.trim();
      const example_url = document.getElementById("example_url").value.trim();
      const extra_bien = document.getElementById("extra_bien").value.trim();
      const logo = document.getElementById("logo").value.trim();
      const photo1 = document.getElementById("photo1").value.trim();
      const photo2 = document.getElementById("photo2").value.trim();

      const status = document.getElementById("status");
      status.textContent = "â³ Envoi en cours...";

      try {
        const res = await fetch("https://noyer-stripe-server.onrender.com/create-checkout-session", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            nom_agence,
            page_url,
            example_url,
            extra_bien,
            logo,
            photo1,
            photo2,
          }),
        });

        const data = await res.json();
        console.log("RÃ©ponse Stripe:", data);

        if (data.url) {
          status.textContent = "âœ… Redirection vers le paiement...";
          window.location.href = data.url;
        } else {
          status.textContent = "âŒ Erreur : URL de paiement introuvable.";
          console.error("RÃ©ponse Stripe invalide:", data);
        }
      } catch (err) {
        console.error("Erreur Stripe:", err);
        status.textContent = "âŒ Impossible de contacter le serveur Stripe.";
      }
    });
  </script>
</body>
</html>
