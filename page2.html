<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Noyer â€” Ã‰tape 2</title>
  <link rel="stylesheet" href="styles.css" />
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600&display=swap" rel="stylesheet">
</head>
<body>
  <header class="top-bar">
    <span class="logo-text">Noyer</span>
  </header>

  <main class="container">
    <section class="hero">
      <h1>Informations supplÃ©mentaires</h1>
      <p class="subtitle">
        Votre site est compatible âœ…<br>
        ComplÃ©tez les informations suivantes pour finaliser la configuration.
      </p>
    </section>

    <section class="card">
      <form id="extra-form" class="form-grid">
        <!-- ğŸ¢ Nom de l'agence -->
        <div class="field-group full-width">
          <label>ğŸ¢ Nom de votre agence</label>
          <input id="nom_agence" name="nom_agence" type="text" placeholder="Ex : Agence Grandjean Immobilier" required />
        </div>

        <div class="field-group">
          <label>ğŸŒ URL de la page des biens</label>
          <input id="page_url" name="page_url" type="url" readonly class="readonly" />
        </div>

        <div class="field-group">
          <label>ğŸ  URL dâ€™un bien</label>
          <input id="example_url" name="example_url" type="url" readonly class="readonly" />
        </div>

        <div class="field-group">
          <label>ğŸ  URL dâ€™un autre bien</label>
          <input id="extra_bien" name="extra_bien" type="url" placeholder="https://www.votre-agence.fr/biens/maison-456" required />
        </div>

        <div class="field-group">
          <label>ğŸ·ï¸ URL du logo</label>
          <input id="logo" name="logo" type="url" placeholder="https://www.votre-agence.fr/logo.png" required />
        </div>

        <div class="field-group photo-group">
          <label>ğŸ–¼ï¸ URL dâ€™une photo de bien 1</label>
          <input id="photo1" name="photo1" type="url" placeholder="https://www.votre-agence.fr/images/photo1.jpg" required />
        </div>

        <div class="field-group photo-group">
          <label>ğŸ–¼ï¸ URL dâ€™une photo de bien 2</label>
          <input id="photo2" name="photo2" type="url" placeholder="https://www.votre-agence.fr/images/photo2.jpg" required />
        </div>
      </form>

      <p class="info-note">
        ğŸ’¡ Pour trouver les URL de photos, ouvrez une page de bien sur votre site, 
        faites un clic droit sur deux photos diffÃ©rentes, puis choisissez 
        â€œCopier lâ€™adresse de lâ€™imageâ€.
      </p>

      <button id="sendBtn" type="submit" form="extra-form" class="btn-primary">
        ğŸš€ Sâ€™abonner Ã  Noyer
      </button>

      <p id="status" class="status"></p>
    </section>

    <footer class="foot">
      <small>Â© 2025 Noyer. Tous droits rÃ©servÃ©s.</small>
    </footer>
  </main>

  <!-- Ton script de gestion du formulaire -->
  <script src="page2.js"></script>

  <!-- === Stripe Checkout Integration === -->
  <script src="https://js.stripe.com/v3/"></script>
  <script>
    // âš ï¸ Remplace par ta clÃ© publique Stripe
    const stripe = Stripe("pk_test_51SQ7b0KtSUAGLnZOQ518zmedFbxdcflIBXz0DQ9Ve7XumgSGSOcbM5GDcxe4Ct5Rh8QxcNlqXnsCJfiwFuB0KMvt00kO1VJv91");

    document.getElementById("sendBtn").addEventListener("click", async (e) => {
      e.preventDefault();

      const nomAgence = document.getElementById("nom_agence").value.trim();
      const pageUrl = document.getElementById("page_url").value.trim();

      // VÃ©rifie que les champs essentiels sont remplis
      if (!nomAgence || !pageUrl) {
        alert("Veuillez dâ€™abord remplir le formulaire avant de continuer.");
        return;
      }

      try {
        // ğŸ”— Envoi des infos vers ton webhook n8n pour crÃ©er une session Stripe
        const res = await fetch("https://pierre07.app.n8n.cloud/webhook/stripe_checkout", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            nom_agence: nomAgence,
            page_url: pageUrl
          }),
        });

        if (!res.ok) throw new Error("Erreur lors de la communication avec le serveur.");

        const session = await res.json();

        if (!session.id) {
          throw new Error("La rÃ©ponse Stripe nâ€™a pas retournÃ© de session valide.");
        }

        // ğŸš€ Redirige lâ€™utilisateur vers Stripe Checkout
        const { error } = await stripe.redirectToCheckout({ sessionId: session.id });
        if (error) alert(error.message);

      } catch (err) {
        console.error(err);
        alert("âŒ Une erreur est survenue lors de la redirection vers Stripe. RÃ©essayez plus tard.");
      }
    });
  </script>
</body>
</html>
